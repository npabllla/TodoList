<!doctype html>
<html lang="en">
<head>
    <title>ToDo List</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
          integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script>
        $(document).ready(function () {
            loadItems()
            loadCategories()
        })

        function loadItems() {
            const req = $.ajax({
                type: "GET",
                url: "http://localhost:8080/todo/load",
                dataType: "json"
            })
            req.done(function (data) {
                let items = ""
                let user = ""
                for (let i = 0; i < data.length; i++) {
                    let categories = ""
                    for (let j = 0; j < data[i]["categories"].length; j++ ) {
                        categories += data[i]["categories"][j]["name"] + " ";
                    }
                    if (data[i]["status"] !== "Done") {
                        items += "<tr>"
                            + "<td>" + data[i]["description"] + "</td>"
                            + "<td>"+  categories + "</td>"
                            + "<td>" + data[i]["created"] + "</td>"
                            + "<td>" + data[i]["user"]["name"] + "</td>"
                            + "<td>" + "Не выполнено  "
                            + "<input type='checkbox' id='setStatus' value=" + data[i]["id"] + ">"
                            + "</td>"
                            + "</tr>"
                    }
                    user = "Текущий пользователь: " + data[i]["user"]["name"]
                }
                $('#showAll').on('click', function () {
                    $('#items').html(items);
                    $('input:checked:not(:disabled)').each(function () {
                        for (let i = 0; i < data.length; i++) {
                            let categories = ""
                            for (let j = 0; j < data[i]["categories"].length; j++ ) {
                                categories += data[i]["categories"][j]["name"] + " ";
                            }
                            if (data[i]["status"] === "Done") {
                                $('#items').append("<tr style='background: #7dec4c'>"
                                    + "<td>" + data[i]["description"] + "</td>"
                                    + "<td>"+  categories  + "</td>"
                                    + "<td>" + data[i]["created"] + "</td>"
                                    + "<td>" + data[i]["user"]["name"] + "</td>"
                                    + "<td>" + "Выполнено  "
                                    + "<input disabled type='checkbox' id='setStatus' checked value=" + data[i]["id"] + ">"
                                    + "</td>"
                                    + "</tr>");
                            }
                        }
                    });
                });
                $('#items').html(items)
                $('#user').html(user)
            })
        }

        function loadCategories() {
            const req = $.ajax({
                type: "GET",
                url: "http://localhost:8080/todo/categories",
                dataType: "json"
            })
            req.done(function (data) {
                let categories = ""
                for (let i = 0; i < data.length; i++) {
                    categories += "<option value="+data[i]["id"]+">"
                        + data[i]["name"]
                        + "</option>>"
                }
                $('#cIds').html(categories)
            })
        }

        function validate() {
            let result = true
            if ($("#desc").val() === '' || $("#cIds").val() == "") {
                alert("Необходимо ввести описание задачи и выбрать категории")
                result = false
            }
            return result
        }

        function addTask() {
            if (validate()) {
                $.ajax({
                    method: 'POST',
                    url: 'http://localhost:8080/todo/add',
                    data: {description: $("#desc").val(), categoryIds: $('#cIds').val().join(",")},
                    dataType: 'json'
                });
                location.reload()
            }
        }

        function getSelectedValues() {
            let selectedValues = []
            $('input[id=setStatus]:checked:not(:disabled)').each(function (i, e) {
                selectedValues.push($(e).attr('value'))
            })
            return selectedValues;
        }

        function markAsDone() {
            let selectedValues = getSelectedValues()
            if (selectedValues.length > 0) {
                for (let i = 0; i < selectedValues.length; i++) {
                    $.ajax({
                        method: 'POST',
                        url: 'http://localhost:8080/todo/update',
                        data: {id: selectedValues[i]},
                        dataType: 'json'
                    });
                }
                location.reload()
            } else {
                alert("Необходмио выбрать задания")
            }
        }
    </script>
    <style>
        a {
            display: inline;
            float: right;
        }
    </style>
</head>
<body>
<div class="container">
    <form style="margin-top: 15px">
        <h6> Добавить новое задание
            <a id="user"> </a>
        </h6>
        <a class="link" href="http://localhost:8080/todo/login.html">Сменить пользователя</a>
        <div class="form-group">
            <label for="desc">Описание:</label>
            <input class="form-control" id="desc" placeholder="Введите описание задания">
        </div>
        <div class="form-group row" >
            <label class="col-form-label col-sm-3" for="cIds" >Выберите категории: </label>
            <div class="col-sm-5">
                <select class="form-control" id="cIds" multiple="multiple">

                </select>
            </div>
        </div>
        <button type="button" class="btn btn-success" onclick="addTask()">Добавить</button>
    </form>
    <form id="tasks" style="margin-top: 100px">
        <h6>Ваши задачи</h6>
        <p><label>
            <input type="checkbox" id="showAll">
        </label> Показать все</p>
        <table class="table table-bordered">
            <thead>
            <tr>
                <th style="width: 480px;">Описание</th>
                <th style="width: 200px">Категории</th>
                <th style="width: 210px">Дата создания</th>
                <th style="width: 75px">Автор</th>
                <th style="width: 200px">Статус</th>
            </tr>
            </thead>
            <tbody id="items">

            </tbody>
        </table>
        <button type="button" class="btn btn-success" onclick="markAsDone()">Отметить как выполненные</button>
    </form>
</div>
</body>
</html>